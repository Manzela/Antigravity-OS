name: Antigravity Billing Sync

on:
    schedule:
        - cron: "0 0 * * *" # Daily at midnight
    workflow_dispatch: # Manual trigger

permissions:
    contents: read

jobs:
    sync_billing:
        runs-on: ubuntu-latest
        name: Sync GCP Billing to Redis
        steps:
            - name: Checkout Repository
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"

            - name: Install Dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install redis

            - name: Sync Billing Baseline
              env:
                  REDIS_HOST: ${{ secrets.REDIS_HOST }}
                  REDIS_PORT: ${{ secrets.REDIS_PORT }}
                  REDIS_USER: ${{ secrets.REDIS_USER }}
                  REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
                  GCP_BILLING_ACCOUNT_ID: ${{ secrets.GCP_BILLING_ACCOUNT_ID }}
              run: |
                  python3 templates/sentinel/sync_billing.py
