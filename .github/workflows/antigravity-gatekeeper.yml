name: Antigravity Gatekeeper (Rule 08 & 02)
on: [push, pull_request]

jobs:
  governance-gate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Cost Guard (Rule 08)
        run: |
          if [ -f .agent/sentinel/cost_guard.py ]; then
            python .agent/sentinel/cost_guard.py 15.00
          elif [ -f templates/sentinel/cost_guard.py ]; then
            python templates/sentinel/cost_guard.py 15.00
          else
            echo "::error::Cost Guard script not found!"
            exit 1
          fi
      - name: Security Scan (Rule 03)
        run: echo "Running Trivy Scan..."
  
  test-suite:
    needs: governance-gate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 18
      - name: Run Tests
        run: npm test
      - name: Jira Telemetry (Failure Hook)
        if: failure()
        env:
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        run: |
          # Create placeholder log if not exists
          echo "CI Failure at $(date)" > ci_failure.log
          python .agent/observability/jira_bridge.py "Fix [CI] Build Failure" "See Logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" "TNG" --file ci_failure.log
