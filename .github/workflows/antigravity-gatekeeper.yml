name: Antigravity Gatekeeper (Rule 08 & 02)
on: [push, pull_request]

jobs:
  governance-gate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Install Antigravity OS
        run: |
          chmod +x install.sh
          ./install.sh
      - name: Cost Guard (Rule 08)
        run: |
          if [ -f .agent/sentinel/cost_guard.py ]; then
            python3 .agent/sentinel/cost_guard.py 15.00
          else
            echo "::error::Cost Guard script not found!"
            exit 1
          fi
      - name: Security Scan (Rule 03)
        run: echo "Running Trivy Scan..."
  
  test-suite:
    needs: governance-gate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 18
      - name: Install Antigravity OS (Test Env)
        run: |
          chmod +x install.sh
          ./install.sh
      - name: Run Tests
        run: npm test 2> ci_failure.log || echo "Tests Failed"
      - name: Jira Telemetry (Failure Hook)
        if: failure() || hash ci_failure.log 2>/dev/null
        env:
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
          TRACE_ID: ${{ github.run_id }}
        run: |
          if [ -s ci_failure.log ]; then
             echo "Triggering Jira Bridge..."
             
             # Phase 6: Archive to GCS
             GCS_LINK=""
             if [ -n "$GCP_SA_KEY" ]; then
                echo "$GCP_SA_KEY" > gcp_key.json
                gcloud auth activate-service-account --key-file=gcp_key.json
                gsutil cp ci_failure.log gs://antigravity-logging-i-for-ai/$TRACE_ID.log
                GCS_LINK="https://storage.cloud.google.com/antigravity-logging-i-for-ai/$TRACE_ID.log"
             fi
             
             python3 .agent/observability/jira_bridge.py "Fix [CI] Build Failure" "See Logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" "TNG" --log-file ci_failure.log --gcs-link "$GCS_LINK"
          fi
